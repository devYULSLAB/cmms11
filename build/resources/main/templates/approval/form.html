<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결재 작성 - CMMS</title>
    <!-- common CSS is loaded via layout/defaultLayout -->
    <!-- local fallback for design-only preview without server -->
    <link rel="stylesheet" href="../../static/assets/css/base.css" />
    <!-- 인라인 스타일 제거됨 - base.css로 이관 -->
  </head>
  <body>
    <div class="page">
      <header class="appbar">
        <div class="appbar-inner">
          <div class="brand">시스템관리</div>
          <div class="spacer"></div>
          <div class="meta">
            <span class="badge">작성</span>
          </div>
        </div>
      </header>
      <nav class="breadcrumbs">
        <div class="container">
          <a th:href="@{/}">시스템관리</a>
          <span class="sep">/</span>
          <span>결재 작성</span>
        </div>
      </nav>
      <main>
        <div class="container">
          <section data-slot-root th:fragment="content" data-page="approval-form" data-module="approval-form">
          <form class="stack" data-validate method="post" th:action="@{/approval/save}" th:data-redirect="@{/approval/list}">

            <input type="hidden" name="_csrf" value="" data-csrf-field="true" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="isNew" th:value="${isNew}" />
            <input type="hidden" id="fileGroupId" name="fileGroupId" th:value="${approval.fileGroupId}" />
            <section class="card">
              <div class="card-header">
                <div class="card-title">결재 작성</div>
                <div class="toolbar">
                  <a class="btn" th:href="@{/approval/list}">목록</a>
                  <button class="btn" type="submit" name="action" value="draft">임시저장</button>
                  <button class="btn primary" type="submit" name="action" value="submit">
                    <span th:text="${isNew ? '등록' : '수정'}">등록</span>
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="grid cols-12">
                  <div class="form-row col-span-12">
                    <label class="label" for="title">제목</label>
                    <input id="title" name="title" class="input" type="text" placeholder="제목을 입력하세요" required 
                          th:value="${approval.title}" />
                  </div>
                  <div class="form-row col-span-3">
                    <label class="label" for="refEntity">참조 모듈</label>
                    <select id="refEntity" name="refEntity">
                      <option value="">(선택)</option>
                      <option th:each="module : ${refModules}"
                              th:value="${module.code}"
                              th:text="${module.code + ' - ' + module.name}"
                              th:selected="${approval.refEntity == module.code}">
                      </option>
                    </select>
                  </div>
                  <div class="form-row col-span-3">
                    <label class="label" for="refId">참조 ID</label>
                    <input id="refId" name="refId" class="input" type="text" placeholder="예: O250101001" 
                          th:value="${approval.refId}" />
                  </div>
                  <div class="form-row col-span-3">
                    <label class="label" for="status">상태</label>
                    <select id="status" name="status">
                      <option value="">(선택)</option>
                      <option value="DRAFT" th:selected="${!approval.status or approval.status == ''}">임시저장</option>
                      <option value="SUBMIT">상신</option>
                      <option th:each="status : ${statusList}"
                              th:value="${status.code}"
                              th:text="${status.name}"
                              th:selected="${approval.status == status.code}">
                      </option>
                    </select>
                  </div>
                  <!-- 결재선-->
                  <div class="form-row col-span-12">
                    <label class="label">결재선</label>
                    <div class="actions actions-left-align actions-wrap">
                      <input id="member-id-input" class="input input-flex-1" type="text" placeholder="결재자 ID" />
                      <button class="btn" type="button" id="btn-org-picker" title="조직도에서 선택">👥</button>
                      <select id="decision-select" class="select-fixed-120">
                        <option value="APPROVAL">결재</option>
                        <option value="AGREE">합의</option>
                        <option value="INFORM">통보</option>
                      </select>
                      <button class="btn" type="button" id="add-approver">추가</button>
                    </div>
                  </div>
                  <div class="form-row col-span-12">
                    <label class="label"></label>
                    <div class="approver-items actions-top-small" id="approver-items">
                      <div class="empty-message">
                        결재자를 추가하세요.
                      </div>
                    </div>
                  </div>
                  <!-- 본문 -->
                  <div class="form-row col-span-12">
                    <label class="label" for="editor"></label>
                    <div class="editor-toolbar" aria-label="문서 편집기 도구">
                      <button class="btn sm" type="button" data-cmd="bold"><strong>B</strong></button>
                      <button class="btn sm" type="button" data-cmd="italic"><em>I</em></button>
                      <button class="btn sm" type="button" data-cmd="underline"><u>U</u></button>
                      <span class="spacer-12"></span>
                      <button class="btn sm" type="button" data-cmd="insertUnorderedList">목록</button>
                      <button class="btn sm" type="button" data-cmd="insertOrderedList">1. 목록</button>
                      <span class="spacer-12"></span>
                      <button class="btn sm" type="button" data-cmd="undo">실행취소</button>
                      <button class="btn sm" type="button" data-cmd="redo">다시실행</button>
                    </div>
                  </div>
                  <div class="form-row col-span-12">
                    <label class="label" for="editor">본문</label>
                    <div id="editor" class="editor" contenteditable="true" aria-multiline="true" role="textbox" placeholder="본문을 입력하세요"></div>
                    <textarea id="content" name="content" class="editor-hidden"></textarea>
                  </div>                        

                  <div class="form-row col-span-12" data-attachments>
                    <label class="label">첨부</label>
                    <div>
                      <!-- 기존 파일 목록 표시 -->
                      <div data-file-list 
                           th:if="${approval.fileGroupId}"
                           th:attr="data-file-group-id=${approval.fileGroupId}"
                           data-empty-text="첨부된 파일이 없습니다."
                           data-loading-text="첨부 파일을 불러오는 중..."
                           data-error-text="첨부 파일을 불러올 수 없습니다.">
                        <div class="loading">첨부 파일을 불러오는 중...</div>
                      </div>
                      <div th:unless="${approval.fileGroupId}" class="notice">
                        첨부된 파일이 없습니다.
                      </div>
                      
                      <!-- 파일 업로드 UI -->
                      <div class="actions actions-left-align actions-top-small">
                        <input id="attachments-input" class="visually-hidden" type="file" 
                               multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.hwp,.hwpx,.zip,.txt" />
                        <button class="btn" type="button" data-attachments-add>
                          파일 선택
                          <small class="hint">(최대 10MB, jpg,png,pdf,doc,xls,hwp,zip,txt)</small>
                        </button>
                      </div>
                      <ul class="attachments-list actions-top-small" aria-live="polite" aria-label="첨부 파일 목록">
                        <li class="empty">새로 첨부할 파일을 선택하세요.</li>
                      </ul>
                    </div>
                  </div>                  
                </div>
              </div>
            </section>
          </form>
        </div>
      </main>
      <footer>
        <div class="container">© 전자결재</div>
      </footer>
    </div>
    
    <!-- 인라인 스크립트 제거됨 - approval.js로 이관 -->
  </body>
  </html>
