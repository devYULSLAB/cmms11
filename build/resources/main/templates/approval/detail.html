<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결재 상세 · CMMS</title>
    <!-- common CSS is loaded via layout/defaultLayout -->
    <!-- local fallback for design-only preview without server -->
    <link rel="stylesheet" href="../../static/assets/css/base.css" />
    <link rel="stylesheet" href="../../static/assets/css/print.css" />
    <style>
      .doc-header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
      .doc-title{font-size:20px;font-weight:700}
      .meta-row{display:flex;gap:16px;color:var(--fg-muted)}
      .approval-line{margin-top:12px}
      .doc-body{padding:16px;border:1px solid var(--border);border-radius:8px;background:var(--surface)}
      .attachments-list{list-style:none;padding:0;margin:8px 0}
      .attachment-item{display:flex;align-items:center;gap:12px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);margin-bottom:6px}
      .attachment-item .file-name{flex:1;font-size:13px;color:var(--fg)}
      .attachment-item .file-size{flex:0 0 80px;font-size:12px;color:var(--fg-muted);text-align:right}
      .attachment-item .btn-download{flex:0 0 auto;font-size:12px}
    </style>
  </head>
  <body>
    <div class="page">
      <header class="appbar">
        <div class="appbar-inner">
          <div class="brand">전자결재</div>
          <div class="spacer"></div>
          <div class="meta">
            <span class="badge">상세</span>
          </div>
        </div>
      </header>
      <nav class="breadcrumbs">
        <div class="container">
          <a th:href="@{/}">전자결재</a>
          <span class="sep">/</span>
          <a th:href="@{/approval/list}">결재</a>
          <span class="sep">/</span>
          <span>상세</span>
        </div>
      </nav>
      <main>
        <div class="container">
          <section class="card">
            <div class="card-header">
              <div class="row" style="width:100%;justify-content:space-between">
                <div class="card-title">결재 상세</div>
                <div class="toolbar">
                  <a class="btn" th:href="@{/approval/list}">목록</a>
                  <button class="btn danger" 
                          th:data-delete-url="@{/approval/reject/{id}(id=${approval.approvalId})}"
                          th:data-redirect="@{/approval/list}"
                          data-confirm="반려하시겠습니까?">반려</button>
                  <button class="btn primary" 
                          th:data-delete-url="@{/approval/approve/{id}(id=${approval.approvalId})}"
                          th:data-redirect="@{/approval/list}"
                          data-confirm="결재하시겠습니까?">결재</button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="doc-header">
                <div class="doc-title" th:text="${approval.title}">설비 구매 요청의 건</div>
                <div class="meta-row">
                  <div>문서번호: <span th:text="${approval.approvalId}">APR-2025-0001</span></div>
                  <div>기안자: <span th:text="${approval.createdBy}">admin</span></div>
                  <div>작성일: <span th:text="${approval.createdAt}">2025-09-01</span></div>
                  <div>상태: <span class="badge" th:text="${approval.status == 'DRAFT' ? '작성중' : approval.status == 'SUBMITTED' ? '상신' : approval.status == 'IN_PROGRESS' ? '결재중' : approval.status == 'APPROVED' ? '완결' : '반려'}" 
                            th:classappend="${approval.status == 'DRAFT' ? 'badge' : approval.status == 'SUBMITTED' ? 'badge warning' : approval.status == 'IN_PROGRESS' ? 'badge warning' : approval.status == 'APPROVED' ? 'badge success' : 'badge danger'}">결재중</span></div>
                </div>
                <div class="approval-line" th:if="${approval.steps != null and !approval.steps.isEmpty()}">
                  <table class="table">
                    <thead>
                      <tr>
                        <th style="width:60px">순서</th>
                        <th>결재자</th>
                        <th style="width:120px">구분</th>
                        <th style="width:120px">결과</th>
                        <th style="width:180px">일시</th>
                        <th>의견</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="step, iterStat : ${approval.steps}">
                        <td th:text="${step.stepNo}">1</td>
                        <td th:text="${step.memberId}">-</td>
                        <td th:text="${step.decision == 'APPROVAL' ? '결재' : step.decision == 'AGREE' ? '합의' : '통보'}">결재</td>
                        <td>
                          <span class="badge" 
                                th:text="${step.decidedAt != null ? '완료' : '대기'}"
                                th:classappend="${step.decidedAt != null ? 'badge success' : 'badge'}">대기</span>
                        </td>
                        <td th:text="${step.decidedAt != null ? step.decidedAt : '-'}">-</td>
                        <td th:text="${step.comment ?: ''}">-</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="notice" th:if="${approval.steps == null or approval.steps.isEmpty()}">
                  결재선이 설정되지 않았습니다.
                </div>
              </div>

              <div class="doc-body" th:utext="${approval.content}">
                <p>1. 목적: 신규 설비 구매에 대한 승인 요청입니다.</p>
                <p>2. 배경: 생산성 향상을 위해 XYZ 모델의 설비 도입이 필요합니다.</p>
                <p>3. 비용: 120,000,000원 (VAT 별도)</p>
                <p>4. 비고: 설치 일정은 추후 협의</p>
              </div>

              <div class="section" style="margin-top:12px">
                <div class="section-title">첨부</div>
                <ul class="attachments-list" th:if="${attachments != null and !attachments.isEmpty()}">
                  <li class="attachment-item" th:each="file : ${attachments}">
                    <span class="file-name" th:text="${file.originalName}">파일명.pdf</span>
                    <span class="file-size" th:text="${#numbers.formatDecimal(file.size / 1024.0, 1, 1)} + ' KB'">100 KB</span>
                    <a th:href="@{/api/files/{fileId}(fileId=${file.fileId}, groupId=${approval.fileGroupId})}" 
                       class="btn-download" target="_blank">다운로드</a>
                  </li>
                </ul>
                <div th:if="${attachments == null or attachments.isEmpty()}" class="notice">
                  첨부된 파일이 없습니다.
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
      <footer>
        <div class="container">© 전자결재</div>
      </footer>
    </div>
    
  </body>
  </html>
