<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CMMS · Layout</title>
    <link rel="stylesheet" href="../assets/css/base.css" />
    <style>
      html, body { height: 100%; overflow: hidden; }
      /* Layout grid to keep footer fixed at bottom and content sized */
      .layout {
        display: grid;
        grid-template-areas:
          "header header"
          "sidebar content"
          "footer footer";
        grid-template-rows: auto 1fr auto;
        grid-template-columns: 250px 1fr;
        height: 100vh; /* lock viewport height so only content scrolls */
      }
      .header { grid-area: header; }
      .sidebar { grid-area: sidebar; border-right:1px solid var(--border); padding:12px; overflow:auto; }
      .content { grid-area: content; overflow:auto; -webkit-overflow-scrolling: touch; }
      .footer { grid-area: footer; }
      /* Ensure a consistent visual height even when content is sparse */
      #layout-slot { min-height: 480px; }
      /* Sidebar menu */
      .sidemenu { display:block; }
      .menu-group { margin-bottom: 8px; border-radius: 6px; }
      .menu-title { display:flex; align-items:center; width:100%; padding:8px 10px; background: var(--bg-subtle); border:1px solid var(--border); border-radius:6px; cursor:pointer; font-weight:600; color:var(--fg); }
      .menu-title:focus { outline: 2px solid var(--focus); outline-offset: 1px; }
      .menu-items { padding:6px 8px 4px 12px; }
      .menu-group:not(.open) .menu-items { display:none; }
      .menu-item { display:block; padding:6px 4px; color: var(--fg); text-decoration: none; border-radius:4px; }
      .menu-item:hover { background: var(--bg-subtle); }
      .menu-item.active { background: var(--accent-a10); color: var(--accent-contrast); }
      @media (max-width: 860px){
        .layout {
          grid-template-areas:
            "header"
            "content"
            "footer";
          grid-template-columns: 1fr;
        }
        .sidebar { display:none; }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <header class="header appbar">
        <div class="appbar-inner">
          <div class="brand">CMMS</div>
          <div class="spacer"></div>
          <nav class="meta">
            <span id="user-info" style="margin-right:12px;color:var(--fg-muted)">사용자 정보를 불러오는 중…</span>
            <a class="btn sm" href="/api/auth/logout" data-hard-nav>로그아웃</a>
          </nav>
        </div>
      </header>
      <aside class="sidebar">
        <nav class="sidemenu">
          <!-- 설비관리 -->
          <div class="menu-group open" data-group>
            <button type="button" class="menu-title" aria-expanded="true">자산관리</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/plant/form.html}">등록</a>
              <a class="menu-item" href="@{/plant/list.html}">목록</a>
              <a class="menu-item" href="@{/plant/history.html}">이력</a>
            </div>
          </div>

          <!-- 점검관리 -->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">점검관리</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/inspection/plan.html}">계획</a>
              <a class="menu-item" href="@{/inspection/form.html}">등록(결과)</a>
              <a class="menu-item" href="@{/inspection/list.html}">목록</a>
            </div>
          </div>

          <!-- 작업관리 -->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">작업관리</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/workorder/form.html}">등록(결과)</a>
              <a class="menu-item" href="@{/workorder/list.html}">목록</a>
            </div>
          </div>

          <!-- 작업허가 -->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">작업허가</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/workpermit/form.html}">등록(결과)</a>
              <a class="menu-item" href="@{/workpermit/list.html}">목록</a>
            </div>
          </div>

          <!-- 재고처리  -->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">재고처리</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/inventoryTx/transaction.html}">입고</a>
              <a class="menu-item" href="@{/inventoryTx/closing.html}">마감</a>
              <a class="menu-item" href="@{/inventoryTx/ledger.html}">원장(레포트)</a>
            </div>
          </div>

          <!-- 결재관리 -->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">결재관리</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/approval/form.html}">작성</a>
              <a class="menu-item" href="@{/approval/list.html}">결재함</a>
            </div>
          </div>

          <!-- 문서/게시 -->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">문서/게시</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/memo/form.html}">작성</a>
              <a class="menu-item" href="@{/memo/list.html}">목록</a>
            </div>
          </div>

          <!-- 기본정보(도메인) -->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">기본정보</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/domain/company/list}">회사</a>
              <a class="menu-item" href="@{/domain/site/list}">사업장(사이트)</a>
              <a class="menu-item" href="@{/domain/dept/list}">부서</a>
              <a class="menu-item" href="@{/domain/func/list}">기능위치</a>
              <a class="menu-item" href="@{/domain/storage/list}">창고(스토리지)</a>
              <a class="menu-item" href="@{/domain/member/list}">사용자</a>
              <a class="menu-item" href="@{/domain/role/list}">권한</a>
            </div>
          </div>

          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">공통코드</button>
            <div class="menu-items">
              <a class="menu-item" href="@{/code/types}">코드 타입</a>
              <a class="menu-item" href="@{/code/items}">코드 항목</a>
            </div>
          </div>
        </nav>
      </aside>
      <main class="content">
        <div class="container">
          <div id="layout-slot"></div>
        </div>
      </main>
      <footer class="footer">
        <div class="container">© CMMS</div>
      </footer>
    </div>
    <script src="../assets/js/app.js"></script>
    <script>
      (function() {
        // Function의 로딩 순서 (function 이름)
        // 1. CSRF 토큰 에러 처리 및 핵심 유틸리티 함수들 정의(toCsrfError)
        // 2. Thymeleaf 스타일 링크와 상대/절대 URL을 실제 URL로 변환하는 함수(resolveUrl)
        // 3. 브라우저 히스토리에 상태를 저장하고 URL을 업데이트하는 함수(setState)
        // 4. 현재 페이지에 해당하는 사이드바 메뉴 항목을 활성화하는 함수(setActive)
        // 5. AJAX로 콘텐츠를 가져와서 슬롯에 삽입하고 폼 제출을 인터셉트하는 핵심 함수(loadContent)
        // 6. URL을 해석하고 적절한 콘텐츠로 네비게이션하는 함수(navigate)
        // 7. Delegate delete actions inside slot using [data-delete-url]
        // 8. Fetch and render logged-in user info into header(loadUserInfo)
        // 9. Intercept all clicks for SPA-like navigation(bindDeleteHandlerOnce)
        // 10. Handle back/forward(handleBackForward)
        // 11. Initial load(initialLoad)
        // 12. Sidebar toggle for top-level menu groups(toggleSidebar)

        // CSRF 토큰 에러 처리 및 핵심 유틸리티 함수들 정의
        const CSRF_ERROR_NAME = 'CsrfForbiddenError'; // CSRF 에러 식별자

        // CSRF 토큰 에러를 특별한 에러 객체로 변환하는 유틸리티 함수
        function toCsrfError(response) {
          if (typeof createCsrfForbiddenError === 'function') {
            return createCsrfForbiddenError(response);
          }
          const error = new Error('Forbidden');
          error.name = CSRF_ERROR_NAME;
          error.response = response;
          return error;
        }

        const slot = document.getElementById('layout-slot'); // 콘텐츠가 삽입될 슬롯 요소
        if (!slot) return;

        let currentContentUrl = '../plant/list.html'; // 현재 로드된 콘텐츠 URL

        // Thymeleaf 스타일 링크와 상대/절대 URL을 실제 URL로 변환하는 함수
        function resolveUrl(href, basePath) {
          try {
            // Handle unprocessed Thymeleaf-style links like '@{/domain/company/list}'
            if (href && href.startsWith('@{') && href.endsWith('}')) {
              href = href.slice(2, -1); // strip '@{' and '}'
            }
            // Absolute or external URLs: return as-is
            if (href.startsWith('http://') || href.startsWith('https://') || href.startsWith('/')) {
              return href;
            }

            // Treat non-HTML app routes (e.g., domain/company/list, api/...) as root-relative
            const isHtmlFile = /\.html($|[?#])/.test(href);
            if (!isHtmlFile) {
              return '/' + href.replace(/^\/+/, '');
            }

            // For HTML partials, resolve relative to the current content directory
            const baseDir = (() => {
              if (!basePath) return '/';
              const idx = basePath.lastIndexOf('/');
              if (idx <= 0) return '/';
              return basePath.slice(0, idx + 1);
            })();
            const u = new URL(href, window.location.origin + baseDir);
            return u.pathname + u.search;
          } catch (_) {
            return href;
          }
        }

        // 브라우저 히스토리에 상태를 저장하고 URL을 업데이트하는 함수
        function setState(contentUrl, push) {
          const url = '/layout/defaultLayout.html?content=' + encodeURIComponent(contentUrl);
          const state = { content: contentUrl };
          if (push) history.pushState(state, '', url);
          else history.replaceState(state, '', url);
        }

        // 현재 페이지에 해당하는 사이드바 메뉴 항목을 활성화하는 함수
        function setActive(contentUrl) {
          try {
            const links = document.querySelectorAll('.sidebar .menu-item');
            const targetPath = new URL(contentUrl, window.location.origin).pathname;
            links.forEach((a) => {
              a.classList.remove('active');
              const href = a.getAttribute('href') || '';
              if (!href.startsWith('/layout/')) return;
              const u = new URL(href, window.location.origin);
              const c = u.searchParams.get('content') || '';
              if (!c) return;
              if (new URL(c, window.location.origin).pathname === targetPath) {
                a.classList.add('active');
                const grp = a.closest('.menu-group');
                if (grp && !grp.classList.contains('open')) {
                  grp.classList.add('open');
                  const btn = grp.querySelector('.menu-title');
                  if (btn) btn.setAttribute('aria-expanded', 'true');
                }
              }
            });
          } catch (_) { /* noop */ }
        }

        // AJAX로 콘텐츠를 가져와서 슬롯에 삽입하고 폼 제출을 인터셉트하는 핵심 함수
        function loadContent(contentUrl, opts = { push: false }) {
          currentContentUrl = contentUrl;
          if (opts.push === true) setState(contentUrl, true);
          
          // URL 유효성 검사
          if (!contentUrl || contentUrl.trim() === '') {
            console.warn('Empty content URL, redirecting to default');
            navigate('../plant/list.html');
            return;
          }
          
          // 잘못된 URL 패턴 검사
          if (contentUrl.includes('..') && contentUrl.split('..').length > 2) {
            console.warn('Invalid URL pattern detected:', contentUrl);
            slot.innerHTML = `
              <div class="notice danger">
                <h3>잘못된 URL입니다</h3>
                <p>보안상의 이유로 해당 URL에 접근할 수 없습니다.</p>
                <a class="btn primary" href="@{~/domain/company/list}">목록으로 이동</a>
              </div>
            `;
            return;
          }
          
          fetch(contentUrl, { credentials: 'same-origin' })
            .then(r => {
              if (r.status === 403) {
                throw toCsrfError(r);
              }
              return r.text();
            })
            .then(html => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const main = doc.querySelector('main');
              slot.innerHTML = main ? main.innerHTML : (doc.body ? doc.body.innerHTML : html);
              // Try to sync CSRF hidden fields if available
              if (typeof window.cmms?.refreshCsrfForms === 'function') {
                try { window.cmms.refreshCsrfForms(); } catch (_) {}
              }

              // Intercept SPA-friendly form submissions inside slot
              // Use [data-redirect] to decide where to navigate after success
              const forms = slot.querySelectorAll('form[data-redirect]');
              forms.forEach((form) => {
                // avoid duplicate binding
                if (form.__cmmsHandled) return;
                form.__cmmsHandled = true;
                form.addEventListener('submit', (e) => {
                  try {
                    e.preventDefault();
                    const action = form.getAttribute('action') || '';
                    const method = (form.getAttribute('method') || 'post').toUpperCase();
                    const redirectTo = form.getAttribute('data-redirect') || currentContentUrl;
                    const formData = new FormData(form);
                    fetch(action, {
                      method,
                      body: formData,
                      credentials: 'same-origin'
                    }).then((res) => {
                      if (res.status === 403) throw toCsrfError(res);
                      if (!res.ok) throw new Error('Submit failed: ' + res.status);
                      navigate(redirectTo);
                    }).catch((err) => {
                      console.error(err);
                      const notice = document.createElement('div');
                      notice.className = 'notice danger';
                      notice.textContent = '저장에 실패했습니다. 잠시 후 다시 시도하세요.';
                      form.prepend(notice);
                    });
                  } catch (err) {
                    console.error(err);
                  }
                });
              });
              setActive(currentContentUrl);
              const title = doc.querySelector('title');
              if (title && title.textContent) document.title = title.textContent + ' · CMMS';
            })
            .catch(err => {
              if (err && err.name === CSRF_ERROR_NAME) {
                return;
              }
              console.error('Content load error:', err);
              
              // URL이 잘못된 경우 기본 페이지로 리다이렉트
              if (err.message.includes('404') || err.message.includes('Not Found')) {
                slot.innerHTML = `
                  <div class="notice danger">
                    <h3>페이지를 찾을 수 없습니다</h3>
                    <p>요청하신 페이지가 존재하지 않습니다.</p>
                    <a class="btn primary" href="@{~/domain/company/list}">홈으로 이동</a>
                  </div>
                `;
                // 3초 후 자동으로 기본 페이지로 이동
                setTimeout(() => {
                  navigate('../plant/list.html');
                }, 3000);
              } else if (err.message.includes('403') || err.message.includes('Forbidden')) {
                slot.innerHTML = `
                  <div class="notice danger">
                    <h3>접근 권한이 없습니다</h3>
                    <p>이 페이지에 접근할 권한이 없습니다.</p>
                    <a class="btn primary" href="@{~/domain/company/list}">목록으로 이동</a>
                  </div>
                `;
              } else {
                slot.innerHTML = `
                  <div class="notice danger">
                    <h3>콘텐츠를 불러오지 못했습니다</h3>
                    <p>네트워크 오류 또는 서버 문제가 발생했습니다.</p>
                    <button class="btn primary" onclick="location.reload()">새로고침</button>
                    <a class="btn" href="@{~/domain/company/list}">목록으로 이동</a>
                  </div>
                `;
              }
            });
        }

        // URL을 해석하고 적절한 콘텐츠로 네비게이션하는 함수
        function navigate(targetHref) {
          const contentUrl = targetHref.startsWith('/layout/')
            ? (new URLSearchParams(new URL(targetHref, window.location.origin).search).get('content') || '../plant/list.html')
            : resolveUrl(targetHref, currentContentUrl);
          try { console.debug('[cmms-nav]', { targetHref, base: currentContentUrl, contentUrl }); } catch (_) {}
          setState(contentUrl, true);
          loadContent(contentUrl, { push: false });
        }

        // Delegate delete actions inside slot using [data-delete-url]
        (function bindDeleteHandlerOnce() {
          if (slot.__cmmsDeleteBound) return;
          slot.__cmmsDeleteBound = true;
          slot.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-delete-url]');
            if (!btn) return;
            e.preventDefault();
            const url = btn.getAttribute('data-delete-url');
            const redirectTo = btn.getAttribute('data-redirect') || currentContentUrl;
            const confirmMsg = btn.getAttribute('data-confirm');
            if (confirmMsg && !confirm(confirmMsg)) return;
            fetch(url, { method: 'POST', credentials: 'same-origin' })
              .then((res) => {
                if (res.status === 403) throw toCsrfError(res);
                if (!res.ok) throw new Error('Delete failed: ' + res.status);
                navigate(redirectTo);
              })
              .catch((err) => {
                console.error(err);
                alert('삭제에 실패했습니다. 잠시 후 다시 시도하세요.');
              });
          }, { capture: true });
        })();

        // Fetch and render logged-in user info into header
        (function loadUserInfo() {
          const el = document.getElementById('user-info');
          if (!el) return;
          fetch('/api/auth/me', { credentials: 'same-origin' })
            .then(r => {
              if (r.status === 401) {
                window.location.href = '/auth/login.html';
                return null;
              }
              if (r.status === 403) {
                throw toCsrfError(r);
              }
              return r.ok ? r.json() : null;
            })
            .then(data => {
              if (!data) return;
              const name = data.name || data.memberId || '사용자';
              const company = data.companyId ? ` (${data.companyId})` : '';
              el.textContent = `${name}${company}`;
              el.title = `ID: ${data.memberId || ''}${data.deptId ? `, 부서: ${data.deptId}` : ''}`.trim();
            })
            .catch((err) => {
              if (err && err.name === CSRF_ERROR_NAME) {
                return;
              }
              el.textContent = '사용자 정보 로드 실패';
            });
        })();

        // Intercept all clicks for SPA-like navigation
        document.addEventListener('click', function(e) {
          const anchor = e.target.closest('a[href]');
          if (anchor && anchor.getAttribute('href')) {
            const href = anchor.getAttribute('href');
            // Bypass SPA for external, auth, or explicit hard-nav links
            if (
              href.startsWith('http') ||
              href.startsWith('mailto:') ||
              href.startsWith('#') ||
              href.startsWith('/api/auth/logout') ||
              href.startsWith('/auth/') ||
              anchor.hasAttribute('data-hard-nav') ||
              anchor.target === '_blank'
            ) {
              return; // let browser handle
            }
            e.preventDefault();
            navigate(href);
            return;
          }
          const row = e.target.closest('[data-row-link]');
          if (row) {
            const link = row.getAttribute('data-row-link');
            if (link) {
              e.preventDefault();
              navigate(link);
            }
          }
        }, { capture: true });

        // Handle back/forward
        window.addEventListener('popstate', (e) => {
          const content = e.state?.content || new URLSearchParams(window.location.search).get('content') || '../plant/list.html';
          try {
            loadContent(content, { push: false });
          } catch (err) {
            console.error('Navigation error:', err);
            // 에러 발생 시 기본 페이지로 이동
            navigate('../plant/list.html');
          }
        });

        // Initial load
        const initialContent = new URLSearchParams(window.location.search).get('content') || '../plant/list.html';
        setState(initialContent, false);
        loadContent(initialContent, { push: false });

        // Sidebar toggle for top-level menu groups
        document.querySelectorAll('.sidebar .menu-title').forEach((btn) => {
          btn.addEventListener('click', () => {
            const grp = btn.closest('.menu-group');
            if (!grp) return;
            const willOpen = !grp.classList.contains('open');
            grp.classList.toggle('open', willOpen);
            btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
          });
        });
      })();
    </script>
  </body>
  </html>
