<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¡œê·¸ì¸ Â· CMMS</title>
    <link rel="stylesheet" href="../../static/assets/css/base.css" />
  </head>
  <body>
    <main class="container" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
      <section class="card" style="width:100%;max-width:420px">
        <div class="card-header">
          <div class="card-title">ë¡œê·¸ì¸</div>
        </div>
        <div class="card-body">
          <form id="login-form" data-validate action="/api/auth/login" method="post">
            <!-- íšŒì‚¬ ì„ íƒ (ë™ì  ë¡œë”©) -->
            <div class="stack">
              <label class="label" for="company_id">íšŒì‚¬</label>
              <select id="company_id" class="input" required>
                <option value="">íšŒì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option th:each="company : ${companies}" 
                        th:value="${company.companyId}"
                        th:text="${company.name + ' (' + company.companyId + ')'}"
                        th:selected="${company.companyId == lastCompanyId}">
                  ì´ˆë¡ì—ë„ˆì§€ (CHROK)
                </option>
              </select>
            </div>
            
            <!-- ì•„ì´ë”” -->
            <div class="stack" style="margin-top:12px">
              <label class="label" for="user_id">ì•„ì´ë””</label>
              <input id="user_id" class="input" required maxlength="10" autocomplete="username" placeholder="ì˜ˆ: admin" 
                     th:value="${lastUsername}" />
            </div>
            
            <!-- member_id hidden field (companyId:userId í˜•ì‹ìœ¼ë¡œ ì „ì†¡) -->
            <input type="hidden" id="member_id" name="member_id" />
            
            <!-- ë¹„ë°€ë²ˆí˜¸ -->
            <div class="stack" style="margin-top:12px">
              <label class="label" for="password">ë¹„ë°€ë²ˆí˜¸</label>
              <input id="password" name="password" class="input" type="password" required maxlength="100" autocomplete="current-password" />
            </div>
            
            <!-- âœ¨ ë¡œê·¸ì¸ ì •ë³´ ì €ì¥ ì²´í¬ë°•ìŠ¤ -->
            <div class="stack" style="margin-top:12px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="remember_login" name="remember_login" value="true" 
                       th:checked="${rememberLogin}" />
                <span>ë¡œê·¸ì¸ ì •ë³´ ì €ì¥ (30ì¼)</span>
              </label>
            </div>
            
            <input type="hidden" name="_csrf" value="" data-csrf-field="true" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div id="login_error" class="notice danger-text" style="display:none;margin-top:12px"></div>
            <div class="actions" style="margin-top:16px">
              <button class="btn primary" type="submit">ë¡œê·¸ì¸</button>
            </div>
          </form>
        </div>
      </section>
    </main>
    <!-- ë¡œê·¸ì¸ í˜ì´ì§€ì— í•„ìš”í•œ ìµœì†Œí•œì˜ ES ëª¨ë“ˆë§Œ ë¡œë”© -->
    <script type="module">
      // ë¡œê·¸ì¸ í˜ì´ì§€ì— í•„ìš”í•œ í•µì‹¬ ëª¨ë“ˆë§Œ import
      import { initCsrf } from '../../static/assets/js/core/csrf.js';
      import { initValidator } from '../../static/assets/js/ui/validator.js';
      
      // ìµœì†Œí•œì˜ ì´ˆê¸°í™” (ë¡œê·¸ì¸ í˜ì´ì§€ì— í•„ìš”í•œ ê¸°ëŠ¥ë§Œ)
      try {
        console.log('ğŸ” ë¡œê·¸ì¸ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
        
        // 1. CSRF í† í° ì²˜ë¦¬ (í¼ ì œì¶œì— í•„ìˆ˜)
        initCsrf();
        console.log('  âœ… CSRF í† í° ì´ˆê¸°í™” ì™„ë£Œ');
        
        // 2. í¼ ìœ íš¨ì„± ê²€ì‚¬ (data-validate ì†ì„± ì²˜ë¦¬)
        initValidator();
        console.log('  âœ… í¼ ìœ íš¨ì„± ê²€ì‚¬ ì´ˆê¸°í™” ì™„ë£Œ');
        
        // 3. URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        const params = new URLSearchParams(window.location.search);
        const hasError = params.get('error');
        const customMsg = params.get('msg');
        const errorEl = document.getElementById('login_error');
        
        if (errorEl && hasError) {
          // â­ ë³´ì•ˆ: ëª¨ë“  ë¡œê·¸ì¸ ì‹¤íŒ¨ë¥¼ ë™ì¼í•œ ë©”ì‹œì§€ë¡œ í‘œì‹œ (ê³„ì • ì¡´ì¬ ìœ ë¬´ ë…¸ì¶œ ë°©ì§€)
          errorEl.textContent = customMsg ? decodeURIComponent(customMsg) : 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          errorEl.setAttribute('role', 'alert');
          errorEl.style.display = 'block';
          console.log('  âš ï¸ ë¡œê·¸ì¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ');
        }
        
        // 4. ë¡œê·¸ì¸ í¼ submit ì‹œ companyId:userId í˜•ì‹ìœ¼ë¡œ ì¡°í•©
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
          loginForm.addEventListener('submit', function(e) {
            const companyId = document.getElementById('company_id').value;
            const userId = document.getElementById('user_id').value.trim();
            const memberIdField = document.getElementById('member_id');
            const errorEl = document.getElementById('login_error');
            
            // â­ ë³´ì•ˆ ê²€ì¦: userIdì— ì½œë¡ (:) í¬í•¨ ì°¨ë‹¨ (êµ¬ë¶„ì ë³´í˜¸)
            if (userId.includes(':')) {
              e.preventDefault();
              if (errorEl) {
                errorEl.textContent = 'ì•„ì´ë””ì— ì½œë¡ (:)ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                errorEl.style.display = 'block';
              }
              return false;
            }
            
            // â­ companyId:userId í˜•ì‹ìœ¼ë¡œ ì¡°í•©
            if (!companyId) {
              e.preventDefault();
              if (errorEl) {
                errorEl.textContent = 'íšŒì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
                errorEl.style.display = 'block';
              }
              return false;
            }
            
            // â­ ëª¨ë“  íšŒì‚¬ì— ëŒ€í•´ companyId:userId í˜•ì‹ìœ¼ë¡œ ì „ì†¡
            memberIdField.value = companyId + ':' + userId;
            
            console.log('  ğŸ“¤ ë¡œê·¸ì¸ ì‹œë„:', memberIdField.value);
          });
          console.log('  âœ… ë¡œê·¸ì¸ í¼ ì´ë²¤íŠ¸ ë“±ë¡ ì™„ë£Œ');
        }
        
        console.log('ğŸ‰ ë¡œê·¸ì¸ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        
      } catch (error) {
        console.error('âŒ ë¡œê·¸ì¸ í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        // ì´ˆê¸°í™” ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ë¡œê·¸ì¸ ê¸°ëŠ¥ì€ ë™ì‘í•˜ë„ë¡ í•¨
      }
    </script>
    
    <!-- ê¸°ì¡´ ë°©ì‹ (ë¡¤ë°±ìš©) -->
    <!-- <script src="../../static/assets/js/app.js"></script> -->
  </body>
  </html>
