<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CMMS · Layout</title>
    <link rel="stylesheet" th:href="@{/assets/css/base.css}" href="../../static/assets/css/base.css" />
    <link rel="stylesheet" th:href="@{/assets/css/print.css}" href="../../static/assets/css/print.css" />
    <link rel="stylesheet" th:href="@{/assets/css/layout.css}" href="../../static/assets/css/layout.css" />
    <!-- layout styles moved to /assets/css/layout.css -->
  </head>
  <body>
    <div class="layout">
      <header class="header appbar">
        <div class="appbar-inner">
          <div class="brand">CMMS</div>
          <div class="spacer"></div>
          <nav class="meta">
            <!-- 사용자 정보 영역 표준화: 인라인 스타일을 CSS 클래스로 변경 -->
            <div class="user-info-group">
              <div th:if="${isAuthenticated}" class="user-profile">
                <div class="user-name" th:text="${memberId + ' (' + companyId + ')'}">사용자</div>
                <div class="user-detail" th:text="'부서: ' + ${deptId ?: '-'} + ' / 사이트: ' + ${siteId ?: '-'}">-</div>
              </div>
              <span th:if="${!isAuthenticated}" class="guest-user">게스트 사용자</span>
              <div class="user-actions">
                <button th:if="${isAuthenticated}" class="btn sm" type="button" id="btn-profile-edit" title="프로필 편집">프로필</button>
                <a class="btn sm" th:href="@{/api/auth/logout}" href="/api/auth/logout" data-hard-nav>로그아웃</a>
              </div>
            </div>
          </nav>
        </div>
      </header>
      <!-- 
        사이드바 네비게이션 - 라우터 네비게이션 링크 통합
        
        [라우터 통합 방식]
        - 링크 클릭 시 페이지 새로고침 없이 동적 콘텐츠 교체
        - href 속성은 브라우저 기본 기능과 서버 사이드 렌더링 호환성 유지
        - JavaScript 네비게이션이 우선 동작하며, 실패 시 기본 브라우저 동작으로 폴백
        
        [SPA 통합 방식]
        1. 링크 클릭 → 기본 이벤트 방지
        2. href URL 분석 → 적절한 콘텐츠 요청
        3. 서버 응답 처리 → layout-slot에 동적 삽입  
        4. URL 변경 → 브라우저 히스토리 관리
        5. 라우터 슬롯에 동적 삽입
        
        [문제 발생 시 폴백]
        JavaScript 네비게이션 실패 시 기본 브라우저 동작으로 폴백
        서버 응답 처리 실패 시 기본 브라우저 동작으로 폴백
      -->
      <aside class="sidebar">
        <nav class="sidemenu">
          <!-- 공장 관리 메뉴-->
          <div class="menu-group open" data-group>
            <button type="button" class="menu-title" aria-expanded="true">설비 관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/plant/form}" href="/plant/form">설비 등록</a>
              <a class="menu-item" th:href="@{/plant/list}" href="/plant/list">설비 목록</a>
              <a class="menu-item" th:href="@{/plant/history}" href="/plant/history">설비 이력</a>
            </div>
          </div>

          <!-- 재고 관리 메뉴-->
          <div class="menu-group open" data-group>
            <button type="button" class="menu-title" aria-expanded="true">재고 관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/inventory/form}" href="/inventory/form">재고 등록</a>
              <a class="menu-item" th:href="@{/inventory/list}" href="/inventory/list">재고 목록</a>
            </div>
          </div>

          <!-- 점검관리 메뉴-->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">점검관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/inspection/plan}" href="/inspection/plan">계획수립</a>
              <a class="menu-item" th:href="@{/inspection/form}" href="/inspection/form">등록(결과)</a>
              <a class="menu-item" th:href="@{/inspection/list}" href="/inspection/list">목록</a>
            </div>
          </div>

          <!-- 작업관리 메뉴-->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">작업관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/workorder/form(mode=plan)}" href="/workorder/form?mode=plan">계획 등록</a>
              <a class="menu-item" th:href="@{/workorder/form(mode=actual)}" href="/workorder/form?mode=actual">실적 입력</a>
              <a class="menu-item" th:href="@{/workorder/form(mode=all)}" href="/workorder/form?mode=all">전체 등록</a>
              <a class="menu-item" th:href="@{/workorder/list}" href="/workorder/list">목록</a>
            </div>
          </div>

          <!-- 작업허가 관리 메뉴-->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">작업허가 관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/workpermit/form}" href="/workpermit/form">등록(결과)</a>
              <a class="menu-item" th:href="@{/workpermit/list}" href="/workpermit/list">목록</a>
            </div>
          </div>

          <!-- 재고처리 관리 메뉴-->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">재고처리 관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/inventoryTx/transaction}" href="/inventoryTx/transaction">처리</a>
              <a class="menu-item" th:href="@{/inventoryTx/closing}" href="/inventoryTx/closing">마감</a>
              <a class="menu-item" th:href="@{/inventoryTx/ledger}" href="/inventoryTx/ledger">원장(레포트)</a>
            </div>
          </div>

          <!-- 결재관리 메뉴-->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">결재관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/approval/form}" href="/approval/form">작성</a>
              <a class="menu-item" th:href="@{/approval/list}" href="/approval/list">결재함</a>
            </div>
          </div>

          <!-- 메모 관리 메뉴-->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">메모 관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/memo/form}" href="/memo/form">작성</a>
              <a class="menu-item" th:href="@{/memo/list}" href="/memo/list">목록</a>
            </div>
          </div>

          <!-- 도메인 관리 메뉴-->
          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">도메인 관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/domain/company/list}" href="/domain/company/list">회사</a>
              <a class="menu-item" th:href="@{/domain/site/list}" href="/domain/site/list">사업장(사이트)</a>
              <a class="menu-item" th:href="@{/domain/dept/list}" href="/domain/dept/list">부서</a>
              <a class="menu-item" th:href="@{/domain/func/list}" href="/domain/func/list">기능위치</a>
              <a class="menu-item" th:href="@{/domain/storage/list}" href="/domain/storage/list">창고(스토리지)</a>
              <a class="menu-item" th:href="@{/domain/member/list}" href="/domain/member/list">사용자</a>
              <a class="menu-item" th:href="@{/domain/role/list}" href="/domain/role/list">권한</a>
            </div>
          </div>

          <div class="menu-group" data-group>
            <button type="button" class="menu-title" aria-expanded="false">공통코드 관리 메뉴</button>
            <div class="menu-items">
              <a class="menu-item" th:href="@{/code/types}" href="/code/types">코드 타입</a>
            </div>
          </div>
        </nav>
      </aside>
      <!-- 
        메인 콘텐츠 영역 - SPA 라우터 시스템의 핵심 동작 원리
        
        [SPA 라우터 동작 방식]
        1. 초기 페이지 로드 시: content 파라미터로 지정된 페이지가 이 슬롯에 삽입됨
        2. 네비게이션 시: app.js의 navigation.navigate()가 새 콘텐츠를 이 슬롯에 동적 삽입
        3. 페이지 전환: DOM 조작을 통해 기존 콘텐츠를 새 콘텐츠로 교체
        
        [문제 발생 시 폴백]
        - URL 변경 시 브라우저 히스토리 관리
        - /workorder/list content="/workorder/list" 동작 실패 시 기본 브라우저 동작으로 폴백
        - 서버 응답 처리 실패 시 기본 브라우저 동작으로 폴백
        - JavaScript 네비게이션 실패 시 기본 브라우저 동작으로 폴백
      -->
      <main class="content">
        <div class="container">
          <!-- SPA 라우터 슬롯 - 동적 콘텐츠가 삽입되는 영역 -->
          <div id="layout-slot" data-slot-root></div>
        </div>
      </main>
      <footer class="footer">
        <div class="container">CMMS</div>
      </footer>
    </div>
    <!-- 공통 JavaScript 라이브러리 로드 -->
    <script th:src="@{/assets/js/app.js}" src="../../static/assets/js/app.js"></script>
    <script th:src="@{/assets/js/common.js}" src="../../static/assets/js/common.js"></script>
    
    <!-- 파일 위젯 (필요시 활성화) -->
    <!-- <script src="../assets/js/file-widget.js"></script> -->
    
    <!-- SPA 네비게이션 및 초기 콘텐츠 설정 -->
    <script>
      // SPA 네비게이션 초기화
      document.addEventListener('DOMContentLoaded', () => {
        window.cmms.navigation.init();
      });
    </script>
    
    <script th:inline="javascript">
      // 초기 콘텐츠 설정
      window.initialContent = /*[[${content}]]*/ '/plant/list.html';
      
      // 파일 업로드 설정 로드
      window.fileUploadConfig = {
        maxSize: /*[[${fileUploadConfig.maxSize}]]*/ 10485760,
        allowedExtensions: /*[[${fileUploadConfig.allowedExtensions}]]*/ ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'hwp', 'hwpx', 'zip', 'txt'],
        maxSizeFormatted: /*[[${fileUploadConfig.maxSizeFormatted}]]*/ '10MB',
        profile: /*[[${fileUploadConfig.profile}]]*/ 'default'
      };
      console.log('파일 업로드 설정 로드', window.fileUploadConfig);
      console.log('파일 업로드 설정 로드', window.fileUploadConfig.profile);
    </script>
    
    <script>
      (function() {
        const profileButton = document.getElementById("btn-profile-edit");
        if (profileButton) {
          profileButton.addEventListener("click", () => {
            const width = 700;
            const height = 650;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            const popup = window.open(
              "/common/profile-edit",
              "profileEdit",
              `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );

            if (!popup) {
              try {
                window.cmms?.notification?.warning("팝업이 차단되었습니다. 브라우저 설정을 확인해주세요.");
              } catch (error) {
                console.warn("팝업 차단 알림 실패", error);
              }
            }
          });
        }

        window.addEventListener("message", (event) => {
          if (event.origin !== window.location.origin) return;
          const data = event.data;
          if (!data || data.type !== "PROFILE_UPDATED") return;

          const normalize = (value) => {
            if (value === undefined || value === null) return "-";
            const text = String(value).trim();
            return text.length ? text : "-";
          };

          const detailEl = document.querySelector(".user-detail");
          if (detailEl) {
            const payload = data.payload || {};
            detailEl.textContent = `부서 ${normalize(payload.deptId)} / 사이트 ${normalize(payload.siteId)}`;
          }
        });
      })();
    </script>

  </body>
  </html>