<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결재 상세 · CMMS</title>
    <!-- common CSS is loaded via layout/defaultLayout -->
    <!-- local fallback for design-only preview without server -->
    <link rel="stylesheet" href="../../static/assets/css/base.css" />
    <link rel="stylesheet" href="../../static/assets/css/print.css" />
    <!-- 인라인 스타일 제거됨 - base.css로 이관 -->
  </head>
  <body>
    <div class="page">
      <main>
        <div class="container">
          <section data-slot-root th:fragment="content" data-page="approval-detail" data-module="approval-detail">
          <section class="card">
            <div class="card-header">
              <div class="row actions-space-between">
                <div class="card-title">결재 상세</div>
                <div class="toolbar">
                  <a class="btn" th:href="@{/approval/list}">목록</a>
                  <a class="btn" href="#" data-print-btn>인쇄</a>
                  
                  <!-- 의견 입력 및 결재 버튼 -->
                  <div style="display:flex; gap:8px; align-items:center;">                    
                    <button class="btn primary" 
                            onclick="approveWithComment()"
                            th:attr="data-approval-id=${approval.approvalId}">
                      승인
                    </button>                    
                    <button class="btn danger" 
                            onclick="rejectWithComment()"
                            th:attr="data-approval-id=${approval.approvalId}">
                      반려
                    </button>                    
                    <input type="text" 
                           id="approval-comment" 
                           class="input" 
                           placeholder="의견 입력 (선택)" 
                           maxlength="500"
                           style="width: 500px; height: 36px;" />
                  </div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="doc-header">
                <div class="doc-title" th:text="${approval.title}">설비 구매 요청의 건</div>
                <div class="meta-row">
                  <div>문서번호: <span th:text="${approval.approvalId}">APR-2025-0001</span></div>
                  <div>기안자: <span th:text="${approval.createdBy}">admin</span></div>
                  <div>작성일: <span th:text="${approval.createdAt}">2025-09-01</span></div>
                  <div>상태: <span class="badge"
                            th:text="${approval.status == 'APPRV' or approval.status == 'CMPLT' ? '승인' : approval.status == 'PROC' ? '처리중' : approval.status == 'SUBMT' ? '제출' : approval.status == 'DRAFT' ? '기안' : approval.status == 'REJCT' ? '반려' : '기타'}"
                            th:classappend="${approval.status == 'APPRV' or approval.status == 'CMPLT' ? 'success' : approval.status == 'PROC' ? 'info' : approval.status == 'REJCT' ? 'danger' : ''}">처리중</span></div>
                </div>
                <div class="meta-row" th:if="${approval.refEntity != null && approval.refId != null}">
                  <div>참조: <span class="badge info" th:text="${approval.refEntity}">INSP</span></div>
                  <div>
                    문서 ID: <span th:text="${approval.refId}">I250101001</span>
                    <button type="button" 
                            class="btn xs" 
                            onclick="openRefDocPopup(this.dataset.module, this.dataset.id)"
                            th:attr="data-module=${approval.refEntity}, data-id=${approval.refId}"
                            title="원본 문서 보기">
                      📄
                    </button>
                  </div>
                  <div th:if="${approval.refStage != null}">
                    단계: <span class="badge" th:text="${approval.refStage == 'PLN' ? '계획' : approval.refStage == 'ACT' ? '실적' : approval.refStage}">계획</span>
                  </div>
                </div>
                <div class="approval-line" th:if="${approval.steps != null and !approval.steps.isEmpty()}">
                  <table class="table">
                    <thead>
                      <tr>
                        <th class="table-col-number">순서</th>
                        <th class="table-col-name-medium">결재자</th>
                        <th class="table-col-type-medium">구분</th>
                        <th class="table-col-type-medium">결과</th>
                        <th class="table-col-date-large">일시</th>
                        <th class="table-col-info-small">의견</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="step, iterStat : ${approval.steps}">
                        <td th:text="${step.stepNo}">1</td>
                        <td th:text="${step.memberId}">-</td>
                        <td th:text="${step.decision == 'APPROVAL' ? '결재' : step.decision == 'AGREE' ? '합의' : '통보'}">결재</td>
                        <td>
                          <span th:if="${step.result == 'APPRV'}" class="badge success">승인</span>
                          <span th:if="${step.result == 'REJCT'}" class="badge danger">반려</span>
                          <span th:if="${step.result == null}" class="badge">대기</span>
                        </td>
                        <td th:text="${step.decidedAt != null ? step.decidedAt : '-'}">-</td>
                        <td th:text="${step.comment ?: ''}">-</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="notice" th:if="${approval.steps == null or approval.steps.isEmpty()}">
                  결재선이 설정되지 않았습니다.
                </div>
              </div>

              <div class="doc-body" th:utext="${approval.content}">
                <p>1. 목적: 신규 설비 구매에 대한 승인 요청입니다.</p>
                <p>2. 배경: 생산성 향상을 위해 XYZ 모델의 설비 도입이 필요합니다.</p>
                <p>3. 비용: 120,000,000원 (VAT 별도)</p>
                <p>4. 비고: 설치 일정은 추후 협의</p>
              </div>

              <div class="section actions-top-small">
                <div class="section-title">첨부</div>
                <div data-file-list 
                     th:if="${approval.fileGroupId}"
                     th:attr="data-file-group-id=${approval.fileGroupId}"
                     data-empty-text="첨부된 파일이 없습니다."
                     data-loading-text="첨부 파일을 불러오는 중..."
                     data-error-text="첨부 파일을 불러올 수 없습니다.">
                  <div class="file-list"></div>
                </div>
                <div th:unless="${approval.fileGroupId}" class="notice">
                  첨부된 파일이 없습니다.
                </div>
              </div>
            </div>
            
            <!-- 출력 문서 형식 -->
            <section class="print-form" aria-hidden="true">
              <div class="doc">
                <header class="doc-header">
                  <div class="doc-title">전자결재</div>
                  <div class="doc-meta">
                    <div class="meta-row">출력일시: <span id="print-date">-</span></div>
                    <div class="meta-row">인쇄자: <span id="print-user">-</span></div>
                  </div>
                </header>
                
                <div class="doc-body">
                  <!-- 기본 정보 -->
                  <div class="section">
                    <div class="section-title">기본 정보</div>
                    <div class="row"><strong>문서번호</strong><span class="spacer"></span><span th:text="${approval.approvalId}">APR-2025-0001</span></div>
                    <div class="row"><strong>결재 제목</strong><span class="spacer"></span><span th:text="${approval.title}">설비 구매 요청의 건</span></div>
                    <div class="row"><strong>기안자</strong><span class="spacer"></span><span th:text="${approval.createdBy}">admin</span></div>
                    <div class="row"><strong>작성일</strong><span class="spacer"></span><span th:text="${approval.createdAt}">2025-09-01</span></div>
                    <div class="row"><strong>결재 상태</strong><span class="spacer"></span><span th:text="${approval.status == 'APPRV' or approval.status == 'CMPLT' ? '승인' : approval.status == 'PROC' ? '처리중' : approval.status == 'SUBMT' ? '제출' : approval.status == 'DRAFT' ? '기안' : approval.status == 'REJCT' ? '반려' : '기타'}">처리중</span></div>
                  </div>

                  <!-- 결재선 정보 -->
                  <div class="section" th:if="${approval.steps != null and !approval.steps.isEmpty()}">
                    <div class="section-title">결재선</div>
                    <table class="row-cols-6">
                      <thead>
                        <tr>
                          <th>순서</th>
                          <th>결재자</th>
                          <th>구분</th>
                          <th>결과</th>
                          <th>일시</th>
                          <th>의견</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr th:each="step : ${approval.steps}">
                          <td th:text="${step.stepNo}">1</td>
                          <td th:text="${step.memberId}">-</td>
                          <td th:text="${step.decision == 'APPROVAL' ? '결재' : step.decision == 'AGREE' ? '합의' : '통보'}">결재</td>
                          <td th:text="${step.result == 'APPRV' ? '승인' : step.result == 'REJCT' ? '반려' : '대기'}">대기</td>
                          <td th:text="${step.decidedAt != null ? step.decidedAt : '-'}">-</td>
                          <td th:text="${step.comment ?: '-'}">-</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- 본문 내용 -->
                  <div class="section">
                    <div class="section-title">본문 내용</div>
                    <div class="content-body" th:utext="${approval.content}">
                      <p>1. 목적: 신규 설비 구매에 대한 승인 요청입니다.</p>
                      <p>2. 배경: 생산성 향상을 위해 XYZ 모델의 설비 도입이 필요합니다.</p>
                      <p>3. 비용: 120,000,000원 (VAT 별도)</p>
                      <p>4. 비고: 설치 일정은 추후 협의</p>
                    </div>
                  </div>

                  <!-- 첨부 파일 -->
                  <div class="section">
                    <div class="section-title">첨부 파일</div>
                    <div class="file-list" th:if="${approval.fileGroupId}">
                      <div class="notice">첨부 파일 목록 (파일 그룹 ID: <span th:text="${approval.fileGroupId}">-</span>)</div>
                    </div>
                    <div class="notice" th:unless="${approval.fileGroupId}">
                      첨부된 파일이 없습니다.
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </section>
        </div>
      </main>
    </div>
  </body>
  </html>
