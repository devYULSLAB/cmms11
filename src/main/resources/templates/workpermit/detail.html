<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>작업허가 상세 · CMMS</title>
    <!-- common CSS is loaded via layout/defaultLayout -->
    <!-- local fallback for design-only preview without server -->
    <link rel="stylesheet" href="../../static/assets/css/base.css" />
    <link rel="stylesheet" href="../../static/assets/css/print.css" />
    
    <!-- 팝업 모드 스타일 -->
    <style th:if="${param.popup != null}">
      body::before {
        content: '📄 작업허가 상세 정보';
        display: block;
        padding: 16px 20px;
        background: var(--primary);
        color: white;
        font-size: 18px;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .page { padding: 0; }
      .container { max-width: 100%; padding: 20px; }
    </style>
  </head>
  <body>
    <div class="page">
      <div th:replace="common/approval-line-modal :: approval-line-modal"></div>
      <!-- Main Content -->
      <section data-slot-root th:fragment="content" data-page="workpermit-detail" data-module="workpermit-detail"
               th:attr="data-file-group-id=${workpermit.fileGroupId},data-permit-id=${workpermit.permitId},data-dept-id=${workpermit.deptId},data-print-enabled=true">
        <main>
        <div class="container">
          <section class="card">
            <div class="card-header">
              <div class="row actions-space-between">
                <div class="card-title">작업허가 상세</div>
                <div class="toolbar" th:unless="${param.popup != null}">
                  <!-- 항상 활성화 -->
                  <a class="btn" th:href="@{/workpermit/list}">목록</a>
                  <a class="btn" href="#" data-print-btn>인쇄</a>
                  
                  <!-- 수정: status=DRAFT일 때만 활성화 -->
                  <a class="btn" 
                     th:classappend="${workpermit.status == 'DRAFT' ? 'primary' : 'disabled'}"
                     th:href="${workpermit.status == 'DRAFT' ? '/workpermit/form?id=' + workpermit.permitId : '#'}">
                    수정
                  </a>
                  
                  <!-- 결재 상신: status=DRAFT일 때만 활성화 (PLN/ACT 무관) -->
                  <button class="btn" 
                          th:classappend="${workpermit.status == 'DRAFT' ? 'primary' : 'disabled'}"
                          th:disabled="${workpermit.status != 'DRAFT'}"
                          th:attr="onclick='submitApproval(\'' + ${workpermit.permitId} + '\', \'' + ${workpermit.stage} + '\', \'workpermits\', \'workpermit\')'">
                    결재 상신
                  </button>
                  
                  <!-- 담당자 확정: status=DRAFT일 때만 활성화 (PLN/ACT 모두) -->
                  <button class="btn" 
                          th:classappend="${workpermit.status == 'DRAFT' ? 'success' : 'disabled'}"
                          th:disabled="${workpermit.status != 'DRAFT'}"
                          th:attr="onclick='confirmComplete(\'' + ${workpermit.permitId} + '\', \'workpermits\', \'workpermit\')'">
                    담당자 확정
                  </button>
                  
                  <!-- 실적 입력: stage=PLN AND status=APPRV/CMPLT일 때만 활성화 -->
                  <a class="btn" 
                     th:classappend="${workpermit.stage == 'PLN' and (workpermit.status == 'APPRV' or workpermit.status == 'CMPLT') ? 'success' : 'disabled'}"
                     th:href="${workpermit.stage == 'PLN' and (workpermit.status == 'APPRV' or workpermit.status == 'CMPLT') ? '/workpermit/form?stage=ACT&amp;refEntity=PERM&amp;refId=' + workpermit.permitId + '&amp;refStage=PLN' : '#'}">
                    실적 입력
                  </a>
                </div>
              </div>
            </div>
            <div class="card-body">
              
              <!-- 알림 메시지 표시 -->
              <div th:if="${message}" 
                   class="alert alert-success"
                   style="margin-bottom: 20px; padding: 12px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;"
                   th:text="${message}">
              </div>
              <div th:if="${errorMessage}" 
                   class="alert alert-error"
                   style="margin-bottom: 20px; padding: 12px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;"
                   th:text="${errorMessage}">
              </div>
              
              <!-- 기본정보 -->
              <div class="section">
                <div class="section-title">기본정보</div>
                <div class="grid cols-12">
                  <div class="stack col-span-3">
                    <div class="label">허가 번호</div>
                    <div th:text="${workpermit.permitId}">P250101001</div>
                  </div>
                  <div class="stack col-span-6">
                    <div class="label">작업명</div>
                    <div th:text="${workpermit.name}">배관 용접 작업</div>
                  </div>
                  <div class="stack col-span-3">
                    <div class="label">계획/실적</div>
                    <div th:text="${workpermit.stage == 'PLN' ? '계획' : workpermit.stage == 'ACT' ? '실적' : workpermit.stage}">계획</div>
                  </div>
                </div>
                <div class="grid cols-12">
                  <div class="stack col-span-3">
                    <div class="label">설비 번호</div>
                    <div th:text="${workpermit.plantId}">EQP000123</div>
                  </div>
                  <div class="stack col-span-3">
                    <div class="label">허가유형</div>
                    <div th:text="${workpermit.jobId}">HOT</div>
                  </div>
                  <div class="stack col-span-3">
                    <div class="label">Site</div>
                    <div th:text="${workpermit.siteId}">SEOUL</div>
                  </div>
                  <div class="stack col-span-3">
                    <div class="label">관리부서</div>
                    <div th:text="${workpermit.deptId}">설비팀</div>
                  </div>
                </div>
              </div>

              <!-- 일정/담당 -->
              <div class="section">
                <div class="section-title">일정 / 담당</div>
                  <div class="grid cols-12">                  
                  <div class="stack col-span-3">
                    <div class="label">계획일</div>
                      <div th:text="${workpermit.plannedDate}">2025-01-12</div>
                  </div>
                  <div class="stack col-span-3">
                    <div class="label">실적일</div>
                    <div th:text="${workpermit.actualDate}">2025-01-12</div>
                  </div>
                  <div class="stack col-span-3">
                    <div class="label">담당자</div>
                    <div th:text="${workpermit.memberId}">M0001</div>
                  </div>
                  <div class="stack col-span-3">
                    <div class="label">상태</div>
                    <div>
                      <span class="badge" 
                            th:text="${workpermit.status == 'APPRV' or workpermit.status == 'CMPLT' ? '승인' : workpermit.status == 'PROC' ? '진행중' : workpermit.status == 'SUBMT' ? '상신' : workpermit.status == 'DRAFT' ? '준비중' : '기타'}" 
                            th:classappend="${workpermit.status == 'APPRV' or workpermit.status == 'CMPLT' ? 'success' : workpermit.status == 'PROC' ? 'info' : workpermit.status == 'REJCT' ? 'danger' : ''}">준비중</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 결재 정보 섹션 -->
              <div class="section" th:if="${workpermit.approvalId != null}">
                <div class="section-title">결재 정보</div>
                <div class="grid cols-12">
                  <div class="stack col-span-4">
                    <div class="label">결재 번호</div>
                    <div>
                      <a th:href="@{/approval/detail/{id}(id=${workpermit.approvalId})}" 
                         th:text="${workpermit.approvalId}">A250101001</a>
                    </div>
                  </div>            
                </div>
              </div>

              <div class="section">
                <div class="section-title">작업 개요 / 안전</div>
                <div class="grid cols-12">
                  <div class="stack col-span-12"><div class="label">작업 개요</div><div th:text="${workpermit.workSummary}">배관 용접 및 누설 확인</div></div>
                  <div class="stack col-span-6"><div class="label">위험 요인</div><div th:text="${workpermit.hazardFactor}">화재, 화상, 유해가스</div></div>
                  <div class="stack col-span-6"><div class="label">안전 조치</div><div th:text="${workpermit.safetyFactor}">가연물 제거, 소화기 비치, 산소농도 측정</div></div>
                </div>
              </div>

              <div class="section">
                <div class="section-title">안전작업 체크리스트</div>
                <div th:if="${workpermit.checksheetJson}" id="checklist-display">
                  <!-- JavaScript로 동적 렌더링 -->
                </div>
                <div th:unless="${workpermit.checksheetJson}" class="notice">
                  체크리스트 정보가 없습니다.
                </div>
              </div>

              <div class="section">
                <div class="section-title">첨부</div>
                <div data-file-list 
                     th:if="${workpermit.fileGroupId}"
                     th:attr="data-file-group-id=${workpermit.fileGroupId}"
                     data-empty-text="첨부된 파일이 없습니다."
                     data-loading-text="첨부 파일을 불러오는 중..."
                     data-error-text="첨부 파일을 불러올 수 없습니다.">
                  <div class="file-list"></div>
                </div>
                <div th:unless="${workpermit.fileGroupId}" class="notice">
                  첨부된 파일이 없습니다.
                </div>
              </div>

              <!-- 서명자 정보 -->
              <div class="section">
                <div class="section-title">서명</div>
                <table class="table">
                  <thead>
                    <tr>
                      <th class="table-col-number">#</th>
                      <th class="table-col-name-medium">이름</th>
                      <th>서명</th>
                      <th class="table-col-info-small">비고</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="item, iter : ${items}" th:if="${items != null and !items.empty}">
                      <td class="cell-center" th:text="${iter.index + 1}">1</td>
                      <td th:text="${item.name ?: '-'}">홍길동</td>
                      <td>
                        <img th:if="${item.signature}" 
                             th:src="${item.signature}" 
                             alt="서명" 
                             style="max-height:80px;border:1px solid var(--border);background:#fff;padding:4px;" />
                        <span class="muted" th:unless="${item.signature}">서명 없음</span>
                      </td>
                      <td th:text="${item.note ?: '-'}">-</td>
                    </tr>
                    <tr th:if="${items == null or items.empty}">
                      <td colspan="4" class="cell-center muted">서명 정보가 없습니다.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <section class="print-form" aria-hidden="true">
                <div class="doc">
                  <header class="doc-header">
                    <div class="doc-title">작업허가서</div>
                    <div class="doc-meta">
                      <div class="meta-row">출력일시: <span id="print-date">-</span></div>
                      <div class="meta-row">인쇄자: <span id="print-user">-</span></div>
                    </div>
                  </header>
                  
                  <!-- 기본 정보 -->
                  <div class="section">
                    <div class="section-title">기본 정보</div>
                    <table class="row-cols-4">
                      <tr>
                        <th>허가 번호</th><td th:text="${workpermit.permitId}">P250101001</td>
                        <th>작업명</th><td th:text="${workpermit.name}">배관 용접 작업</td>
                      </tr>
                      <tr>
                        <th>설비 번호</th><td th:text="${workpermit.plantId}">EQP000123</td>
                        <th>허가유형</th><td th:text="${workpermit.jobId}">HOT</td>
                      </tr>
                      <tr>
                        <th>계획일</th><td th:text="${workpermit.plannedDate ?: '-'}">2025-01-12</td>
                        <th>실적일</th><td th:text="${workpermit.actualDate ?: '-'}">2025-01-12</td>
                      </tr>
                      <tr>
                        <th>상태</th>
                        <td colspan="3">
                          <span class="badge"
                                th:classappend="${workpermit.status == 'APPRV' or workpermit.status == 'CMPLT' ? 'success' : workpermit.status == 'PROC' ? 'info' : workpermit.status == 'REJCT' ? 'danger' : ''}"
                                th:text="${workpermit.status == 'APPRV' or workpermit.status == 'CMPLT' ? '승인' : workpermit.status == 'PROC' ? '진행중' : workpermit.status == 'SUBMT' ? '상신' : workpermit.status == 'DRAFT' ? '준비중' : '기타'}">
                            준비중
                          </span>
                        </td>
                      </tr>
                    </table>
                  </div>
                  
                  <!-- 체크리스트 정보 -->
                  <div class="section">
                    <div class="section-title">안전작업 체크리스트</div>
                    <div id="print-checklist-display">
                      <!-- JavaScript로 동적 렌더링 -->
                    </div>
                  </div>
                  
                  <!-- 서명 정보 -->
                  <div class="section">
                    <div class="section-title">서명</div>
                    <table>
                      <thead>
                        <tr>
                          <th style="width: 50px;">#</th>
                          <th style="width: 150px;">이름</th>
                          <th>서명</th>
                          <th style="width: 200px;">비고</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr th:each="item, iter : ${items}" th:if="${items != null and !items.empty}">
                          <td th:text="${iter.index + 1}">1</td>
                          <td th:text="${item.name ?: '-'}">홍길동</td>
                          <td>
                            <img th:if="${item.signature}" 
                                 th:src="${item.signature}" 
                                 alt="서명" 
                                 style="max-height: 80px; border: 1px solid #ddd; background: #fff; padding: 4px;" />
                            <span class="muted" th:unless="${item.signature}">서명 없음</span>
                          </td>
                          <td th:text="${item.note ?: '-'}">-</td>
                        </tr>
                        <tr th:if="${items == null or items.empty}">
                          <td colspan="4" class="muted">서명 정보가 없습니다.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </section>
            </div>
          </section>
        </div>
        </main>
      </section>
      
    </div>
    
    <script th:inline="javascript">
      // 체크리스트 데이터 렌더링
      document.addEventListener('DOMContentLoaded', function() {
        const checklistData = /*[[${workpermit.checksheetJson}]]*/ null;
        if (checklistData) {
          try {
            const data = JSON.parse(checklistData);
            renderChecklistDisplay(data, 'checklist-display');
            renderChecklistDisplay(data, 'print-checklist-display');
          } catch (e) {
            console.warn('체크리스트 데이터 파싱 실패:', e);
          }
        }
      });
      
      function renderChecklistDisplay(data, containerId) {
        const container = document.getElementById(containerId);
        if (!container || !data) return;
        
        let html = '';
        
        // 작업 유형별 그룹핑
        const groupedItems = {};
        data.items.forEach(item => {
          if (!groupedItems[item.workType]) {
            groupedItems[item.workType] = [];
          }
          groupedItems[item.workType].push(item);
        });
        
        // 각 작업 유형별로 렌더링
        Object.keys(groupedItems).forEach(workType => {
          const items = groupedItems[workType];
          const workTypeName = getWorkTypeName(workType);
          
          html += '<div class="checklist-group">';
          html += `<div class="group-header">${workTypeName}</div>`;
          
          items.forEach(item => {
            html += '<div class="checklist-item">';
            html += `<span class="item-name">${item.itemName}</span>`;
            html += '<div class="checkbox-group">';
            
            if (item.checked) {
              html += '<span class="checkbox-label confirm">✓ 확인</span>';
            } else if (item.notApplicable) {
              html += '<span class="checkbox-label not-applicable">✓ 해당없음</span>';
            } else {
              html += '<span class="checkbox-label">미선택</span>';
            }
            
            html += '</div>';
            html += '</div>';
          });
          
          html += '</div>';
        });
        
        container.innerHTML = html;
      }
      
      function getWorkTypeName(workType) {
        const names = {
          'COMMON': '공통(일반작업)',
          'FIRE': '화기작업',
          'CONFINED': '밀폐공간작업',
          'ELECTRIC': '전기작업',
          'HIGH': '고소작업',
          'EXCAVATION': '굴착작업(중장비)'
        };
        return names[workType] || workType;
      }
    </script>
  </body>
  </html>
