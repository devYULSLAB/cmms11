<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì„¤ë¹„ ì„ íƒ</title>
    <link rel="stylesheet" th:href="@{/assets/css/base.css}" href="../../static/assets/css/base.css" />
    <style>
      /* ê¸°ëŠ¥ìœ„ì¹˜ ëª©ë¡ */
      .func-list{list-style:none;padding:0;margin:0}
      .func-item{padding:10px 14px;cursor:pointer;border-radius:6px;display:flex;align-items:center;gap:8px;transition:all 0.2s;margin-bottom:4px}
      .func-item:hover{background:var(--surface)}
      .func-item.active{background:var(--primary);color:#fff;font-weight:600}
      .func-item .func-id{flex:0 0 80px;font-weight:600;font-size:13px}
      .func-item .func-name{flex:1;font-size:13px}
      .func-item.active .func-name{color:#fff}
      
      /* ì„¤ë¹„ ëª©ë¡ */
      .plant-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
      .plant-card{border:1px solid var(--border);border-radius:8px;padding:14px;cursor:pointer;transition:all 0.2s;background:var(--surface)}
      .plant-card:hover{border-color:var(--primary);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
      .plant-card.selected{border-color:var(--primary);background:var(--surface);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
      .plant-card .plant-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
      .plant-card .plant-id{font-weight:600;font-size:14px;color:var(--primary)}
      .plant-card.selected .plant-id{color:var(--primary)}
      .plant-card .plant-name{font-weight:600;font-size:15px;margin-bottom:8px}
      .plant-card .plant-info{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted)}
      .plant-card .plant-info .row{display:flex;gap:8px}
      .plant-card .plant-info .label{flex:0 0 60px;font-weight:500;color:var(--fg)}
      .plant-card .plant-info .value{flex:1;word-break:break-all}
      
      .empty-state{text-align:center;padding:48px 24px;color:var(--muted)}
      .empty-state .icon{font-size:48px;margin-bottom:16px;opacity:0.3}
      
      /* íŒì—… ì°½ ìµœì í™” */
      body{overflow:hidden}
    </style>
  </head>
  <body>
    <div class="page">
      <header class="appbar">
        <div class="appbar-inner">
          <div class="brand">ì„¤ë¹„ ì„ íƒ</div>
        </div>
      </header>
      
      <main class="content">
        <div class="container">
          <div class="grid cols-12">
            <!-- ì¢Œì¸¡: ê¸°ëŠ¥ìœ„ì¹˜ ëª©ë¡ -->
            <div class="col-span-4">
              <div class="section">
                <div class="section-title">ê¸°ëŠ¥ìœ„ì¹˜</div>
                <ul class="func-list" id="func-list">
                  <li class="func-item active" data-func-id="">
                    <div class="func-id">(ì „ì²´)</div>
                    <div class="func-name">ì „ì²´ ì„¤ë¹„</div>
                  </li>
                  <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </ul>
              </div>
            </div>
            
            <!-- ìš°ì¸¡: ì„¤ë¹„ ëª©ë¡ -->
            <div class="col-span-8">
              <div class="section">
                <div class="section-title" id="selected-func-name">ì „ì²´ ì„¤ë¹„</div>
                <div class="plant-list" id="plant-list">
                  <div class="empty-state">
                    <div class="icon">ğŸ­</div>
                    <div>ì¢Œì¸¡ì—ì„œ ê¸°ëŠ¥ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      
      <footer class="footer">
        <div class="container">
          <div class="actions">
            <button class="btn" type="button" onclick="window.close()">ì·¨ì†Œ</button>
            <button class="btn primary" type="button" id="btn-select">ì„ íƒ</button>
          </div>
        </div>
      </footer>
    </div>
    
    <!-- í•„ìš”í•œ ëª¨ë“ˆë§Œ ì§ì ‘ ë¡œë“œ (ê²½ëŸ‰í™”) -->
    <script type="module">
      // í•„ìš”í•œ ëª¨ë“ˆë§Œ import
      import { initNotification } from '/assets/js/ui/notification.js';
      import { initDataLoader } from '/assets/js/ui/data-loader.js';
      
      // window.cmms ì´ˆê¸°í™”
      window.cmms = window.cmms || {};
      
      // ëª¨ë“ˆ ì´ˆê¸°í™”
      initNotification();
      initDataLoader();
      
      console.log('âœ… Picker ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ (notification, data-loader)');
    </script>
    
    <script th:inline="javascript">
      (function() {
        'use strict';
        
        // ê¸°ì¡´ window.cmms ê°ì²´ë“¤ë§Œ ì‚¬ìš©
        const notification = window.cmms?.notification || {};
        const dataLoader = window.cmms?.common?.DataLoader || {};
        
        // ì„¤ë¹„ ì„ íƒê¸° í•¸ë“¤ëŸ¬
        const PlantPicker = {
          selectedPlant: null,
          selectedFuncId: '',
          funcData: [],
          
          init: function() {
            this.bindEvents();
            this.loadFuncData();
          },
          
          loadFuncData: async function() {
            try {
              const data = await dataLoader.load('/api/domain/funcs', {size: 1000});
              this.funcData = data.content || data;
              this.renderFuncList();
              this.displayPlants('');
            } catch (error) {
              notification.error('ê¸°ëŠ¥ìœ„ì¹˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
          },
          
          renderFuncList: function() {
            const funcList = document.getElementById('func-list');
            const existingAll = funcList.querySelector('[data-func-id=""]');
            
            this.funcData.forEach(func => {
              const li = document.createElement('li');
              li.className = 'func-item';
              li.dataset.funcId = func.funcId;
              li.innerHTML = `
                <div class="func-id">${func.funcId}</div>
                <div class="func-name">${func.name || '-'}</div>
              `;
              funcList.appendChild(li);
            });
          },
          
          displayPlants: async function(funcId) {
            this.selectedFuncId = funcId;
            const func = this.funcData.find(f => f.funcId === funcId);
            
            document.getElementById('selected-func-name').textContent = 
              funcId ? (func ? func.name : 'ê¸°ëŠ¥ìœ„ì¹˜') : 'ì „ì²´ ì„¤ë¹„';
            
            const plantList = document.getElementById('plant-list');
            
            try {
              const params = { size: 1000 };
              if (funcId) params.funcId = funcId;
              
              const data = await dataLoader.load('/api/plants', params);
              const plants = data.content || data;
              
              if (!plants || plants.length === 0) {
                plantList.innerHTML = `
                  <div class="empty-state">
                    <div class="icon">ğŸ­</div>
                    <div>ì„¤ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                  </div>
                `;
                return;
              }
              
              plantList.innerHTML = plants.map(p => `
                <div class="plant-card" 
                     data-plant-id="${p.plantId}"
                     data-name="${p.name || ''}"
                     data-func-id="${p.funcId || ''}"
                     data-dept-id="${p.deptId || ''}"
                     data-maker-name="${p.makerName || ''}"
                     data-serial="${p.serial || ''}">
                  <div class="plant-header">
                    <div class="plant-id">${p.plantId}</div>
                  </div>
                  <div class="plant-name">${p.name || '-'}</div>
                  <div class="plant-info">
                    <div class="row">
                      <div class="label">ê¸°ëŠ¥ìœ„ì¹˜</div>
                      <div class="value">${p.funcId || '-'}</div>
                    </div>
                    <div class="row">
                      <div class="label">ë¶€ì„œ</div>
                      <div class="value">${p.deptId || '-'}</div>
                    </div>
                    <div class="row">
                      <div class="label">ì œì¡°ì‚¬</div>
                      <div class="value">${p.makerName || '-'}</div>
                    </div>
                    <div class="row">
                      <div class="label">ì‹œë¦¬ì–¼</div>
                      <div class="value">${p.serial || '-'}</div>
                    </div>
                  </div>
                </div>
              `).join('');
            } catch (error) {
              notification.error('ì„¤ë¹„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
              plantList.innerHTML = `
                <div class="empty-state">
                  <div class="icon">âš ï¸</div>
                  <div>ì„¤ë¹„ ë¡œë“œ ì‹¤íŒ¨</div>
                </div>
              `;
            }
          },
          
          bindEvents: function() {
            // ê¸°ëŠ¥ìœ„ì¹˜ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('func-list').addEventListener('click', (e) => {
              const funcItem = e.target.closest('.func-item');
              if (funcItem) {
                document.querySelectorAll('.func-item').forEach(item => item.classList.remove('active'));
                funcItem.classList.add('active');
                this.displayPlants(funcItem.dataset.funcId);
              }
            });
            
            // ì„¤ë¹„ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('plant-list').addEventListener('click', (e) => {
              const card = e.target.closest('.plant-card');
              if (card) {
                document.querySelectorAll('.plant-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                
                this.selectedPlant = {
                  plantId: card.dataset.plantId,
                  name: card.dataset.name,
                  funcId: card.dataset.funcId,
                  deptId: card.dataset.deptId,
                  makerName: card.dataset.makerName,
                  serial: card.dataset.serial
                };
              }
            });
            
            // ì„ íƒ ë²„íŠ¼
            document.getElementById('btn-select').addEventListener('click', () => {
              if (!this.selectedPlant) {
                notification.warning('ì„¤ë¹„ë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
              }
              
              // ë¶€ëª¨ ì°½ìœ¼ë¡œ ë°ì´í„° ì „ë‹¬
              if (window.opener && window.opener.onPlantSelected) {
                window.opener.onPlantSelected(this.selectedPlant);
              }
              window.close();
            });
          }
        };
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
          PlantPicker.init();
        });
      })();
    </script>
  </body>
</html>

