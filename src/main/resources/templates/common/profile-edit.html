<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>???뺣낫 ?섏젙</title>
    <!-- common CSS is loaded via layout/defaultLayout -->
    <!-- local fallback for design-only preview without server -->
    <link rel="stylesheet" href="../../static/assets/css/base.css" />
    <style>
      body{margin:0;padding:0;overflow:hidden}
      .profile-edit{display:flex;flex-direction:column;height:100vh;background:var(--bg)}
      .profile-header{padding:20px;border-bottom:1px solid var(--border);background:var(--bg-subtle)}
      .profile-header h2{margin:0;font-size:18px;font-weight:600}
      .profile-body{flex:1;overflow-y:auto;padding:24px}
      .profile-footer{padding:16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;background:var(--surface)}
      .alert{padding:12px;border-radius:6px;margin-bottom:16px}
      .alert-success{background:#d4edda;color:#155724}
      .alert-danger{background:#f8d7da;color:#721c24}
    </style>
  </head>
  <body>
    <div class="profile-edit">
      <div class="profile-header">
        <h2>???뺣낫 ?섏젙</h2>
      </div>
      
      <div class="profile-body">
        <!-- ?깃났/?먮윭 硫붿떆吏 -->
        <div th:if="${successMessage}" class="alert alert-success">
          <span th:text="${successMessage}">?깃났</span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger">
          <span th:text="${errorMessage}">?먮윭</span>
        </div>
        
        <form id="profileForm" method="post" th:action="@{/common/profile-edit}">
          <input type="hidden" name="_csrf" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          
          <div class="section">
            <div class="section-title">湲곕낯 ?뺣낫</div>
            <div class="grid cols-12">
              <div class="form-row col-span-6">
                <label class="label">?ъ슜??ID</label>
                <input class="input" type="text" th:value="${member.memberId}" disabled />
              </div>
              <div class="form-row col-span-6">
                <label class="label">?뚯궗 ID</label>
                <input class="input" type="text" th:value="${member.companyId}" disabled />
              </div>
            </div>
            <div class="grid cols-12">
              <div class="form-row col-span-6">
                <label class="label required" for="name">?대쫫</label>
                <input id="name" name="name" class="input" required maxlength="100" 
                      th:value="${member.name}" />
              </div>
              <div class="form-row col-span-6">
                <label class="label" for="email">?대찓??/label>
                <input id="email" name="email" class="input" type="email" maxlength="100" 
                      th:value="${member.email}" />
              </div>
            </div>
            <div class="grid cols-12">
              <div class="form-row col-span-6">
                <label class="label" for="phone">?꾪솕踰덊샇</label>
                <input id="phone" name="phone" class="input" type="tel" maxlength="100" 
                      th:value="${member.phone}" />
              </div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">?뚯냽 ?뺣낫</div>
            <div class="grid cols-12">
              <div class="form-row col-span-6">
                <label class="label" for="deptId">遺??/label>
                <select id="deptId" name="deptId">
                  <option value="">(?좏깮)</option>
                  <option th:each="dept : ${depts}" 
                          th:value="${dept.deptId}" 
                          th:text="${dept.deptId + ' - ' + dept.name}"
                          th:selected="${member.deptId == dept.deptId}"></option>
                </select>
              </div>
              <div class="form-row col-span-6">
                <label class="label" for="siteId">?ъ씠??/label>
                <select id="siteId" name="siteId">
                  <option value="">(?좏깮)</option>
                  <option th:each="site : ${sites}" 
                          th:value="${site.siteId}" 
                          th:text="${site.siteId + ' - ' + site.name}"
                          th:selected="${member.siteId == site.siteId}"></option>
                </select>
              </div>
            </div>
            <div class="grid cols-12">
              <div class="form-row col-span-6">
                <label class="label" for="position">吏곴툒</label>
                <input id="position" name="position" class="input" maxlength="50" 
                      placeholder="?? ?由? 怨쇱옣, 李⑥옣" th:value="${member.position}" />
              </div>
              <div class="form-row col-span-6">
                <label class="label" for="title">吏곸콉</label>
                <input id="title" name="title" class="input" maxlength="50" 
                      placeholder="?? ??? ?뚰듃?? th:value="${member.title}" />
              </div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">鍮꾨?踰덊샇 蹂寃?/div>
            <div class="help" style="margin-bottom:12px;color:var(--fg-muted);font-size:13px">
              鍮꾨?踰덊샇瑜?蹂寃쏀븯吏 ?딆쑝?ㅻ㈃ 鍮꾩썙?먯꽭??
            </div>
            <div class="grid cols-12">
              <div class="form-row col-span-6">
                <label class="label" for="password">??鍮꾨?踰덊샇</label>
                <input id="password" name="password" class="input" type="password" 
                      maxlength="100" autocomplete="new-password" />
              </div>
              <div class="form-row col-span-6">
                <label class="label" for="passwordConfirm">鍮꾨?踰덊샇 ?뺤씤</label>
                <input id="passwordConfirm" class="input" type="password" 
                      maxlength="100" autocomplete="new-password" />
              </div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">湲고?</div>
            <div class="form-row col-span-12">
              <label class="label" for="note">鍮꾧퀬</label>
              <textarea id="note" name="note" rows="3" maxlength="500" 
                        placeholder="湲고? 硫붾え(理쒕? 500??" th:text="${member.note}"></textarea>
            </div>
          </div>
        </form>
      </div>
      
      <div class="profile-footer">
        <button class="btn" type="button" onclick="window.close()">痍⑥냼</button>
        <button class="btn primary" type="button" id="btn-save">???/button>
      </div>
    </div>
    
            <script th:inline="javascript">
      (function() {
        const saveButton = document.getElementById("btn-save");
        if (saveButton) {
          saveButton.addEventListener("click", () => {
            const form = document.getElementById("profileForm");
            const password = document.getElementById("password").value;
            const passwordConfirm = document.getElementById("passwordConfirm").value;

            if (password || passwordConfirm) {
              if (password !== passwordConfirm) {
                alert("비밀번호가 일치하지 않습니다.");
                return;
              }
              if (password.length < 4) {
                alert("비밀번호는 최소 4글자 이상이어야 합니다.");
                return;
              }
            }

            form.submit();
          });
        }

        const updateSucceeded = /*[[${successMessage != null}]]*/ false;
        if (updateSucceeded && window.opener && !window.opener.closed) {
          const payload = {
            deptId: /*[[${member.deptId}]]*/ null,
            siteId: /*[[${member.siteId}]]*/ null,
            displayName: /*[[${member.name}]]*/ null
          };

          try {
            window.opener.postMessage({ type: "PROFILE_UPDATED", payload }, window.location.origin);
          } catch (error) {
            console.warn("프로필 정보 전달에 실패했습니다.", error);
          }
        }
      })();
    </script>
  </body>
</html>


