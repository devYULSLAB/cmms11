<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì¡°ì§ë„ ì„ íƒ</title>
    <link rel="stylesheet" th:href="@{/assets/css/base.css}" href="../../static/assets/css/base.css" />
    <style>
      /* ë¶€ì„œ íŠ¸ë¦¬ */
      .dept-tree{list-style:none;padding:0;margin:0}
      .dept-tree ul{list-style:none;padding-left:20px;margin:4px 0}
      .dept-item{padding:8px 12px;cursor:pointer;border-radius:6px;display:flex;align-items:center;gap:8px;transition:all 0.2s}
      .dept-item:hover{background:var(--surface)}
      .dept-item.active{background:var(--primary);color:#fff;font-weight:600}
      .dept-item .toggle{flex:0 0 16px;cursor:pointer;user-select:none;font-size:12px}
      .dept-item .toggle.empty{visibility:hidden}
      .dept-item .name{flex:1}
      .dept-item .count{flex:0 0 auto;font-size:11px;color:var(--muted);background:var(--surface);padding:2px 6px;border-radius:3px}
      .dept-item.active .count{background:rgba(255,255,255,0.2);color:#fff}
      
      /* ì¡°ì§ì› ëª©ë¡ */
      .member-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
      .member-card{border:1px solid var(--border);border-radius:8px;padding:14px;cursor:pointer;transition:all 0.2s;background:var(--surface)}
      .member-card:hover{border-color:var(--primary);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
      .member-card.selected{border-color:var(--primary);background:var(--surface)}
      .member-card .member-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
      .member-card .member-name{font-weight:600;font-size:15px}
      .member-card .member-id{font-size:11px;color:var(--muted);background:var(--surface);padding:2px 6px;border-radius:3px}
      .member-card .member-info{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted)}
      .member-card .member-info .row{display:flex;gap:8px}
      .member-card .member-info .label{flex:0 0 50px;font-weight:500;color:var(--fg)}
      .member-card .member-info .value{flex:1}
      
      .empty-state{text-align:center;padding:48px 24px;color:var(--muted)}
      .empty-state .icon{font-size:48px;margin-bottom:16px;opacity:0.3}
      
      /* íŒì—… ì°½ ìµœì í™” */
      body{overflow:hidden}
    </style>
  </head>
  <body>
    <div class="page">
      <header class="appbar">
        <div class="appbar-inner">
          <div class="brand">ì¡°ì§ë„ ì„ íƒ</div>
        </div>
      </header>
      
      <main class="content">
        <div class="container">
          <div class="grid cols-12">
            <!-- ì¢Œì¸¡: ë¶€ì„œ ê³„ì¸µ -->
            <div class="col-span-4">
              <div class="section">
                <div class="section-title">ë¶€ì„œ</div>
                <ul class="dept-tree" id="dept-tree">
                  <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </ul>
              </div>
            </div>
            
            <!-- ìš°ì¸¡: ì¡°ì§ì› ëª©ë¡ -->
            <div class="col-span-8">
              <div class="section">
                <div class="section-title" id="selected-dept-name">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                <div class="member-list" id="member-list">
                  <div class="empty-state">
                    <div class="icon">ğŸ‘¥</div>
                    <div>ì¢Œì¸¡ì—ì„œ ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      
      <footer class="footer">
        <div class="container">
          <div class="actions">
            <button class="btn" type="button" onclick="window.close()">ì·¨ì†Œ</button>
            <button class="btn primary" type="button" id="btn-select">ì„ íƒ</button>
          </div>
        </div>
      </footer>
    </div>
    
    <!-- ê¸°ì¡´ ê³µí†µ ëª¨ë“ˆ ë¡œë“œ -->
    <script src="/assets/js/app.js"></script>
    <script src="/assets/js/common.js"></script>
    
    <script th:inline="javascript">
      (function() {
        'use strict';
        
        // ê¸°ì¡´ window.cmms ê°ì²´ë“¤ë§Œ ì‚¬ìš©
        const notification = window.cmms?.notification || {};
        const dataLoader = window.cmms?.common?.DataLoader || {};
        
        // ì¡°ì§ë„ ì„ íƒê¸° í•¸ë“¤ëŸ¬
        const OrgPicker = {
          selectedMember: null,
          selectedDeptId: null,
          deptData: [],
          
          init: function() {
            this.bindEvents();
            this.loadDeptData();
          },
          
          loadDeptData: async function() {
            try {
              const data = await dataLoader.load('/api/domain/depts', {size: 1000});
              this.deptData = data.content || data;
              this.renderDeptTree();
            } catch (error) {
              notification.error('ë¶€ì„œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
          },
          
          buildDeptTree: function(parentId = null) {
            const children = this.deptData.filter(d => d.parentDeptId === parentId);
            if (children.length === 0) return '';
            
            let html = '<ul>';
            children.forEach(dept => {
              const hasChildren = this.deptData.some(d => d.parentDeptId === dept.deptId);
              const subTree = this.buildDeptTree(dept.deptId);
              
              html += `
                <li>
                  <div class="dept-item" data-dept-id="${dept.deptId}">
                    <span class="toggle ${hasChildren ? '' : 'empty'}">${hasChildren ? 'â–¶' : ''}</span>
                    <span class="name">${dept.name}</span>
                  </div>
                  ${subTree}
                </li>
              `;
            });
            html += '</ul>';
            return html;
          },
          
          renderDeptTree: function() {
            document.getElementById('dept-tree').innerHTML = this.buildDeptTree();
          },
          
          displayMembers: async function(deptId) {
            this.selectedDeptId = deptId;
            const dept = this.deptData.find(d => d.deptId === deptId);
            
            document.getElementById('selected-dept-name').textContent = dept ? dept.name : 'ë¶€ì„œ';
            
            const memberList = document.getElementById('member-list');
            
            try {
              const data = await dataLoader.load('/api/members', {deptId: deptId, size: 1000});
              const members = data.content || data;
              
              if (!members || members.length === 0) {
                memberList.innerHTML = `
                  <div class="empty-state">
                    <div class="icon">ğŸ‘¤</div>
                    <div>ì¡°ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                  </div>
                `;
                return;
              }
              
              memberList.innerHTML = members.map(m => {
                return `
                  <div class="member-card" 
                       data-member-id="${m.memberId}"
                       data-name="${m.name || ''}"
                       data-dept-id="${m.deptId || ''}"
                       data-position="${m.position || ''}"
                       data-title="${m.title || ''}"
                       data-email="${m.email || ''}"
                       data-phone="${m.phone || ''}">
                    <div class="member-header">
                      <div class="member-name">${m.name || '-'}</div>
                      <div class="member-id">${m.memberId}</div>
                    </div>
                    <div class="member-info">
                      <div class="row">
                        <div class="label">ì§ê¸‰</div>
                        <div class="value">${m.position || '-'}</div>
                      </div>
                      <div class="row">
                        <div class="label">ì§ì±…</div>
                        <div class="value">${m.title || '-'}</div>
                      </div>
                      <div class="row">
                        <div class="label">ì´ë©”ì¼</div>
                        <div class="value">${m.email || '-'}</div>
                      </div>
                      <div class="row">
                        <div class="label">ì „í™”</div>
                        <div class="value">${m.phone || '-'}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('');
            } catch (error) {
              notification.error('ì¡°ì§ì› ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
              memberList.innerHTML = `
                <div class="empty-state">
                  <div class="icon">âš ï¸</div>
                  <div>ì¡°ì§ì› ë¡œë“œ ì‹¤íŒ¨</div>
                </div>
              `;
            }
          },
          
          bindEvents: function() {
            // ë¶€ì„œ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('dept-tree').addEventListener('click', (e) => {
              const deptItem = e.target.closest('.dept-item');
              const toggle = e.target.closest('.toggle');
              
              if (toggle && !toggle.classList.contains('empty')) {
                // í† ê¸€ í´ë¦­ - í•˜ìœ„ ë¶€ì„œ í¼ì¹˜ê¸°/ì ‘ê¸°
                const ul = deptItem.parentElement.querySelector('ul');
                if (ul) {
                  ul.style.display = ul.style.display === 'none' ? 'block' : 'none';
                  toggle.textContent = ul.style.display === 'none' ? 'â–¶' : 'â–¼';
                }
              } else if (deptItem) {
                // ë¶€ì„œ ì„ íƒ
                document.querySelectorAll('.dept-item').forEach(item => item.classList.remove('active'));
                deptItem.classList.add('active');
                this.displayMembers(deptItem.dataset.deptId);
              }
            });
            
            // ì¡°ì§ì› í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('member-list').addEventListener('click', (e) => {
              const card = e.target.closest('.member-card');
              if (card) {
                document.querySelectorAll('.member-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                
                const dept = this.deptData.find(d => d.deptId === this.selectedDeptId);
                
                this.selectedMember = {
                  memberId: card.dataset.memberId,
                  name: card.dataset.name,
                  deptId: this.selectedDeptId,
                  deptName: dept ? dept.name : '',
                  position: card.dataset.position,
                  title: card.dataset.title,
                  email: card.dataset.email,
                  phone: card.dataset.phone
                };
              }
            });
            
            // ì„ íƒ ë²„íŠ¼
            document.getElementById('btn-select').addEventListener('click', () => {
              if (!this.selectedMember) {
                notification.warning('ì¡°ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”');
                return;
              }
              
              // ë¶€ëª¨ ì°½ìœ¼ë¡œ ë°ì´í„° ì „ë‹¬
              if (window.opener && window.opener.onMemberSelected) {
                window.opener.onMemberSelected(this.selectedMember);
              }
              window.close();
            });
          }
        };
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
          OrgPicker.init();
        });
      })();
    </script>
  </body>
</html>

